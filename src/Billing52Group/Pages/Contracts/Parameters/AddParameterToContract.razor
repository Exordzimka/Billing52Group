@page "/contracts/{ContractId:int}/parameters/add"
@using Billing52Group.Configuration
@using Billing52Group.Models
@using Microsoft.EntityFrameworkCore
@using Billing52Group.Accounting
@inject ApplicationDbContext Context
@inject NavigationManager NavigationManager
@attribute [Authorize]

@if (parameters != null)
{
    <h3>Create</h3>
    <div class="d-flex justify-content-center">
        <EditForm OnSubmit="@AddModule" Model="@ContractModule" class="form-group d-flex flex-column col-sm-3">
            <DataAnnotationsValidator />
            <ValidationSummary />
            <label>
                Parameter
                <InputSelect id="selectedActivationTypeId" @bind-Value="moduleId" class="form-control">
                    @foreach (var module in parameters)
                    {
                        <option value="@module.Id">@module.Title</option>
                    }
                </InputSelect>
            </label>
            <label>
                Value
                <InputText @bind-Value="ContractModule.Value" class="form-control" />
            </label>
            
            <input type="submit" class="form-control" />
        </EditForm>
    </div>
}

@code 
{
    [Parameter]
    public int ContractId { get; set; }

    private string moduleId;
    IEnumerable<Parameters> parameters;
    IEnumerable<Parameters> _modulesOnContract;
    IEnumerable<ContractParams> _contractModules;
    ContractParams ContractModule = new ContractParams();
    List<int> modulesOnContractId = new List<int>();
    protected override async Task OnInitializedAsync()
    {
        _contractModules = await Context.ContractParams.Where(module => module.ContractId == ContractId).ToListAsync();
        modulesOnContractId.AddRange(_contractModules.Select(module => module.ParamId));
        _modulesOnContract = await Context.Parameters.Where(module => modulesOnContractId.Contains(module.Id)).ToListAsync();
        parameters = await Context.Parameters.Where(module => _modulesOnContract.Contains(module) == false).ToListAsync();
        if (parameters != null && parameters.Count() > 0)
        {
            moduleId = parameters.ElementAt(0).Id.ToString();
        }
    }

    async Task AddModule(EditContext editContext)
    {
        if (!editContext.Validate() ) return;
        if (moduleId != null && int.TryParse(moduleId, out _) && ContractModule.Value != null && ContractModule.Value !="")
        {
            ContractModule.ContractId = ContractId;
            ContractModule.ParamId = int.Parse(moduleId);
            await Context.AddAsync(ContractModule);
            await Context.SaveChangesAsync();
            await BalanceUpdater.UpdateBalance(ContractId);
            NavigationManager.NavigateTo($"/contracts/{ContractId}/parameters");
        }
    }
}


